<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PranayAI</title>
  <style>
    :root {
      --bg: #0b0c10; --card:#11131a; --ink:#e9ecf1; --muted:#aab3c0; --acc:#6aa2ff; --acc2:#4dd6a9; --danger:#ff6a6a;
      --br: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #1a2333, transparent 50%), var(--bg);
      color: var(--ink);
    }
    header{
      padding: 28px 20px; text-align:center;
      border-bottom: 1px solid #1f2533;
      background: linear-gradient(180deg, rgba(106,162,255,.08), transparent);
    }
    header h1{ margin:0 0 6px; font-size: 28px; letter-spacing:.3px }
    header p{ margin:0; color:var(--muted) }

    .wrap{ max-width: 980px; margin: 24px auto 80px; padding: 0 16px }

    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: var(--card); border:1px solid #202534; border-radius: var(--br);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: 16px;
    }
    .span-12{ grid-column: span 12 }
    .span-8{ grid-column: span 8 }
    .span-4{ grid-column: span 4 }
    @media (max-width: 900px){ .span-8,.span-4{ grid-column: span 12 } }

    h2{ font-size: 18px; margin: 4px 0 12px; letter-spacing:.2px }
    label{ font-size: 14px; color: var(--muted); display:block; margin: 10px 0 6px }
    input[type="text"], textarea{
      width:100%; background:#0e1117; color:var(--ink);
      border:1px solid #262b3a; border-radius:10px; padding:12px 12px; outline:none;
    }
    textarea{ min-height: 110px; resize: vertical }
    input[type="file"]{ color:var(--muted) }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{
      background:var(--acc); color:#061020; border:none; border-radius:10px; padding:10px 14px;
      font-weight:600; cursor:pointer;
    }
    .btn.secondary{ background:#1b2434; color:var(--ink); border:1px solid #2b3347 }
    .btn.success{ background: var(--acc2); color:#041313 }
    .btn.danger{ background: var(--danger); color:#2b0a0a }
    .pill{ font-size:12px; padding:6px 8px; border-radius:36px; border:1px solid #2b3347; color:var(--muted) }

    pre{
      background:#0e1117; border:1px solid #262b3a; border-radius:10px; padding:12px; overflow:auto;
      white-space:pre-wrap; word-wrap:break-word; max-height: 340px;
    }
    .muted{ color:var(--muted) }
    .ok{ color: var(--acc2) }
    .err{ color: var(--danger) }
    .src{ font-size:12px; border:1px solid #2b3347; background:#0d121a; border-radius:8px; padding:8px; }

    footer{ text-align:center; color:var(--muted); font-size:12px; padding:24px 0 60px }
    a { color: var(--acc) }
    .spacer{ height:8px }
  </style>
</head>
<body>
  <header>
    <h1>PranayAI</h1>
    <p>Chat with your notes • Upload PDFs/TXT/MD • Ask with RAG</p>
  </header>

  <main class="wrap">

    <!-- Health / status -->
    <section class="grid">
      <div class="card span-12" id="statusCard">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2>Service status</h2>
          <button class="btn secondary" id="btnHealth">Refresh</button>
        </div>
        <div id="health" class="muted">Checking...</div>
      </div>
    </section>

    <!-- Chat -->
    <section class="grid">
      <div class="card span-8">
        <h2>Chat</h2>
        <label for="msg">Message</label>
        <textarea id="msg" placeholder="Ask me something (e.g., ‘summarize AP Biology Unit 3 using my notes’)"></textarea>

        <div class="row" style="margin:10px 0 12px">
          <label class="pill"><input type="checkbox" id="useRag" checked style="margin-right:6px">Use my uploaded data (RAG)</label>
          <span class="pill">Top K: <input id="topk" type="text" value="6" style="width:42px; margin-left:6px; background:transparent; border:none; color:var(--ink)"></span>
          <span class="pill">Max tokens: <input id="maxtok" type="text" value="800" style="width:56px; margin-left:6px; background:transparent; border:none; color:var(--ink)"></span>
          <button class="btn" id="btnSend">Send</button>
        </div>

        <div class="spacer"></div>
        <div class="muted">Reply</div>
        <pre id="reply">–</pre>

        <div class="spacer"></div>
        <div class="muted">Sources</div>
        <div id="sources" class="src">–</div>
      </div>

      <!-- Image chat -->
      <div class="card span-4">
        <h2>Chat with an Image</h2>
        <label for="imgPrompt">Prompt</label>
        <input id="imgPrompt" type="text" placeholder="e.g., Extract and answer from this photo" />

        <label for="imgFile">Image (JPG/PNG)</label>
        <input id="imgFile" type="file" accept="image/*" />

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnImg">Ask</button>
        </div>

        <div class="spacer"></div>
        <div class="muted">Image Reply</div>
        <pre id="imgReply">–</pre>
      </div>
    </section>

    <!-- Ingest -->
    <section class="grid">
      <div class="card span-12">
        <h2>Upload PDFs / TXT / MD</h2>
        <form id="ingestForm" class="row">
          <input id="files" type="file" multiple accept=".pdf,.txt,.md" />
          <button class="btn success" type="submit">Upload</button>
          <button class="btn secondary" type="button" id="btnList">List Sources</button>
          <button class="btn danger" type="button" id="btnClearOne">Delete One</button>
        </form>

        <div class="spacer"></div>
        <div class="muted">Ingest status</div>
        <pre id="ingestOut">–</pre>

        <div class="spacer"></div>
        <div class="muted">Current sources</div>
        <pre id="listOut">–</pre>
      </div>
    </section>
  </main>

  <footer>
    <span>&copy; <script>document.write(new Date().getFullYear())</script> PranayAI</span>
  </footer>

  <script>
    // Helpers
    function show(el, text, isError=false){
      const node = (typeof el === 'string') ? document.getElementById(el) : el;
      node.textContent = text;
      node.classList.toggle('err', !!isError);
      node.classList.toggle('ok', !isError);
    }
    async function getJSON(res){
      const t = await res.text();
      try { return { ok: res.ok, json: JSON.parse(t), raw: t } }
      catch { return { ok: res.ok, json: null, raw: t } }
    }

    // Health
    async function refreshHealth(){
      show('health', 'Checking…');
      try{
        const res = await fetch('/health');
        const { ok, json, raw } = await getJSON(res);
        if(!ok) return show('health', `Server error (${res.status}): ${raw}`, true);
        const bits = [
          json.ok ? 'OK' : 'NOT OK',
          `Claude: ${json.anthropic_ready ? 'ready' : 'not ready'}`,
          `Embeddings: ${json.openai_ready ? 'ready' : 'not ready'}`,
          `Model: ${json.model || '-'}`,
          `Embed: ${json.embed_model || '-'}`
        ];
        show('health', bits.join(' • '));
      }catch(e){ show('health', 'Network error: '+e, true); }
    }

    // Chat
    async function sendChat(){
      const message = document.getElementById('msg').value.trim();
      const useRag  = document.getElementById('useRag').checked;
      const topK    = parseInt(document.getElementById('topk').value || '6', 10);
      const maxTok  = parseInt(document.getElementById('maxtok').value || '800', 10);
      if(!message){ return; }

      show('reply', 'Thinking…'); show('sources','–');
      try{
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, use_rag: useRag, top_k: topK, max_tokens: maxTok })
        });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json){
          return show('reply', `Server error (${res.status}): ${raw}`, true);
        }
        show('reply', json.reply || '(no text)');
        const srcs = (json.sources && json.sources.length)
          ? json.sources.map(s => JSON.stringify(s)).join('\n')
          : '–';
        show('sources', srcs, false);
      }catch(e){
        show('reply', 'Network error: '+e, true);
      }
    }

    // Image Chat
    async function sendImage(){
      const prompt = document.getElementById('imgPrompt').value.trim() || 'Extract text and answer.';
      const file = document.getElementById('imgFile').files[0];
      if(!file){ return show('imgReply','Pick an image first.', true); }

      const fd = new FormData();
      fd.append('file', file);
      fd.append('prompt', prompt);

      show('imgReply', 'Thinking…');
      try{
        const res = await fetch('/chat-image', { method: 'POST', body: fd });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json){
          return show('imgReply', `Server error (${res.status}): ${raw}`, true);
        }
        show('imgReply', json.reply || '(no text)');
      }catch(e){
        show('imgReply', 'Network error: '+e, true);
      }
    }

    // Ingest
    async function ingestFiles(e){
      e.preventDefault();
      const fInput = document.getElementById('files');
      if(!fInput.files.length){ return; }

      const fd = new FormData();
      for(const f of fInput.files) fd.append('files', f);

      show('ingestOut','Uploading…');
      try{
        const res = await fetch('/ingest', { method:'POST', body: fd });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return show('ingestOut', `Server error (${res.status}): ${raw}`, true);
        show('ingestOut', JSON.stringify(json, null, 2));
      }catch(e){
        show('ingestOut', 'Network error: '+e, true);
      }
    }

    // List
    async function listSources(){
      show('listOut','Loading…');
      try{
        const res = await fetch('/list');
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return show('listOut', `Server error (${res.status}): ${raw}`, true);
        show('listOut', JSON.stringify(json, null, 2));
      }catch(e){
        show('listOut', 'Network error: '+e, true);
      }
    }

    // Delete one (by exact filename)
    async function deleteOne(){
      const name = prompt('Type the exact filename to delete (as shown in /list):');
      if(!name) return;
      try{
        const url = `/delete?source=${encodeURIComponent(name)}`;
        const res = await fetch(url, { method:'POST' });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return alert(`Server error (${res.status}): ${raw}`);
        alert(JSON.stringify(json, null, 2));
      }catch(e){
        alert('Network error: '+e);
      }
    }

    // Wire up UI
    document.getElementById('btnHealth').onclick = refreshHealth;
    document.getElementById('btnSend').onclick = sendChat;
    document.getElementById('btnImg').onclick = sendImage;
    document.getElementById('ingestForm').onsubmit = ingestFiles;
    document.getElementById('btnList').onclick = listSources;
    document.getElementById('btnClearOne').onclick = deleteOne;

    // Initial check
    refreshHealth();
  </script>
</body>
</html>
