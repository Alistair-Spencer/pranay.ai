<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pranay AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-3xl mx-auto p-6 space-y-4">
    <header class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-400 to-fuchsia-500"></div>
      <div>
        <h1 class="text-xl font-semibold">Pranay AI</h1>
        <p class="text-slate-400 text-sm">Study coach · RAG from your notes</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <label class="flex items-center gap-2 text-sm">
          <input id="use_docs" type="checkbox" class="accent-indigo-500" checked />
          Use my docs
        </label>
        <select id="mode" class="bg-slate-900 border border-slate-700 rounded-md px-2 py-1 text-sm">
          <option value="default">Default</option>
          <option value="study">Study</option>
          <option value="fitness">Fitness</option>
          <option value="biz">Biz</option>
          <option value="texting">Texting</option>
        </select>
      </div>
    </header>

    <div id="status" class="text-xs text-slate-400"></div>

    <main id="chat" class="h-[60vh] overflow-auto rounded-xl border border-slate-800 bg-slate-900/40 p-4 space-y-3"></main>

    <section class="space-y-3">
      <div class="flex gap-2">
        <textarea id="input" class="flex-1 resize-none bg-slate-900 border border-slate-800 rounded-lg p-3 outline-none"
          rows="2" placeholder="Type a message… (try /study What is mitosis?)"></textarea>
        <button id="send" class="px-4 py-2 bg-indigo-600 rounded-lg disabled:opacity-50">Send</button>
      </div>

      <div class="flex flex-wrap items-center gap-2 text-sm">
        <label class="inline-flex items-center gap-2">
          <input id="img" type="file" accept="image/png,image/jpeg" />
          Add image
        </label>
        <input id="img_prompt" class="flex-1 min-w-[220px] bg-slate-900 border border-slate-800 rounded-lg p-2"
          placeholder="Describe the image or ask a question" />
        <button id="send_img" class="px-3 py-2 bg-fuchsia-600 rounded-lg disabled:opacity-50">Send image</button>
      </div>
    </section>
  </div>

  <script>
    // --- Elements
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const useDocsEl = document.getElementById('use_docs');
    const modeEl = document.getElementById('mode');
    const statusEl = document.getElementById('status');
    const imgEl = document.getElementById('img');
    const imgPromptEl = document.getElementById('img_prompt');
    const sendImgBtn = document.getElementById('send_img');

    // --- Helpers
    function add(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'space-y-1';
      const who = document.createElement('div');
      who.className = 'text-xs text-slate-400';
      who.textContent = role === 'you' ? 'You' : 'Pranay';
      const bubble = document.createElement('div');
      bubble.className = role === 'you'
        ? 'bg-slate-800 rounded-lg p-3'
        : 'bg-slate-900 rounded-lg p-3 border border-slate-800';
      bubble.textContent = text;
      wrap.appendChild(who); wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addSources(sources) {
      if (!sources || !sources.length) return;
      const div = document.createElement('div');
      div.className = 'text-xs text-slate-400';
      div.textContent = 'Sources: ' + sources.map(s => s.source).join(', ');
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setBusy(ok) {
      sendBtn.disabled = !ok;
      sendImgBtn.disabled = !ok;
      inputEl.disabled = !ok;
      imgEl.disabled = !ok;
      imgPromptEl.disabled = !ok;
    }

    async function checkHealth() {
      try {
        const r = await fetch('/healthz', { method: 'GET' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        statusEl.textContent = 'API: healthy';
        setBusy(false); // enable inputs
        setBusy(true);  // temporarily to require first user action
        setBusy(false);
      } catch (e) {
        statusEl.textContent = 'API: not reachable. If this is Render free plan, it may be waking up…';
        setBusy(false); // let the user try; the server may wake on first request
      }
    }

    async function send() {
      const msg = inputEl.value.trim(); if (!msg) return;
      add('you', msg);
      inputEl.value = '';
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            use_docs: useDocsEl.checked,
            mode: modeEl.value
          })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        add('bot', data.reply || '(no reply)');
        addSources(data.sources);
      } catch (err) {
        add('bot', '⚠️ Network error: ' + String(err.message || err));
        console.error(err);
      }
    }

    async function sendImage() {
      const file = imgEl.files?.[0];
      const prompt = imgPromptEl.value || '';
      if (!file) { alert('Choose an image first'); return; }
      add('you', `[Image + prompt] ${prompt}`);
      try {
        const buf = await file.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        const res = await fetch('/vision', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt,
            image_base64: b64,
            filename: file.name
          })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        add('bot', data.reply || '(no reply)');
      } catch (err) {
        add('bot', '⚠️ Image error: ' + String(err.message || err));
        console.error(err);
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) send();
    });
    sendImgBtn.addEventListener('click', sendImage);

    // On load, check API
    checkHealth();
  </script>
</body>
</html>
