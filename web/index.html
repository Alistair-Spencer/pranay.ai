<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Pernai ‚Ä¢ Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* -------- Theme -------- */
:root{
  --bg:#0b0e13; --panel:#0f1420; --sunken:#0c111b;
  --ink:#e9eef6; --muted:#9fb0c7; --line:#1e2635;
  --accent:#69a8ff; --accent-2:#4dd6a9; --danger:#ff6a6a;
  --bubble-user:#1a2233; --bubble-ai:#111827;
  --radius:14px; --shadow: 0 12px 40px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:
    radial-gradient(900px 500px at 80% -10%, #1a2440, transparent 55%),
    radial-gradient(700px 500px at -20% -20%, #142036, transparent 55%),
    var(--bg);
  color:var(--ink); font: 15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

/* -------- Layout -------- */
.app{
  display:grid; grid-template-columns: 280px 1fr; height:100%;
}
.sidebar{
  border-right:1px solid var(--line); background:var(--sunken);
  display:flex; flex-direction:column; padding:16px 12px; gap:12px;
}
.main{ display:flex; flex-direction:column; min-width:0; }

.topbar{
  display:flex; align-items:center; gap:12px;
  padding:14px 18px; border-bottom:1px solid var(--line); background:var(--panel);
}
.brand{
  display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px;
}
.logo{
  width:28px; height:28px; display:inline-block; border-radius:8px;
  background:linear-gradient(135deg, #69a8ff, #7ad6ff 45%, #4dd6a9 100%);
  position:relative; box-shadow: inset 0 0 30px rgba(255,255,255,.25);
}
.logo svg{ position:absolute; inset:0; }
.badge{ color:var(--muted); font-size:12px; margin-left:auto }
.health-ok{ color:var(--accent-2) }
.health-bad{ color:var(--danger) }

/* -------- Sidebar -------- */
.section-title{ color:var(--muted); font-size:12px; letter-spacing:.3px; text-transform:uppercase; margin:8px 8px 6px }
.sidecard{
  background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px;
}
.kv{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px; }
.kv .dot{ width:8px; height:8px; border-radius:50% }
.btn{
  background:var(--accent); color:#07121f; border:none; border-radius:10px; padding:10px 12px;
  font-weight:600; cursor:pointer;
}
.btn.secondary{ background:#1b2437; color:var(--ink); border:1px solid var(--line) }
.btn.ghost{ background:transparent; border:1px solid var(--line); color:var(--ink) }
.btn.small{ font-size:12px; padding:7px 9px; }
.row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.input, textarea, select{
  width:100%; background:#0d1320; color:var(--ink); border:1px solid var(--line);
  border-radius:10px; padding:10px 12px; outline:none;
}

/* -------- Chat area -------- */
.scroll{
  flex:1; overflow:auto; padding:22px 22px 120px;
}
.message{
  display:flex; gap:12px; margin:12px 0;
}
.avatar{
  flex:0 0 30px; height:30px; border-radius:50%; background:#23314a;
  display:grid; place-items:center; font-weight:700; color:#9fc1ff; font-size:12px;
}
.bubble{
  max-width:850px; padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  box-shadow: 0 8px 22px rgba(0,0,0,.25); word-wrap:break-word; white-space:pre-wrap;
}
.ai .bubble{ background:var(--bubble-ai) }
.user .bubble{ background:var(--bubble-user) }
.sources{
  margin-top:8px; font-size:12px; color:var(--muted);
  border-top:1px dashed #21304b; padding-top:8px;
}

/* -------- Composer -------- */
.composer{
  position:fixed; left:280px; right:0; bottom:0; background:linear-gradient(180deg, transparent, rgba(0,0,0,.35));
  padding:18px 22px 20px;
}
.composer-inner{
  max-width:980px; margin:0 auto; background:var(--panel); border:1px solid var(--line);
  border-radius:16px; padding:12px; box-shadow: var(--shadow);
}
.controls{ display:flex; gap:8px; align-items:center; padding:8px; }
.controls .toggle{ display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted) }
.textarea{
  background:#0d1320; border:1px solid var(--line); border-radius:12px; padding:12px;
  min-height:60px; max-height:160px; overflow:auto; color:var(--ink);
}
.actions{ display:flex; gap:8px; justify-content:flex-end; padding-top:8px; }

/* -------- Modal -------- */
.modal-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center;
}
.modal{
  width:min(720px, 92vw); background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px;
  box-shadow:var(--shadow);
}
.modal h3{ margin:6px 0 10px }
hr{ border:0; border-top:1px solid var(--line); margin:12px 0 }

.toast{
  position:fixed; right:18px; bottom:18px; padding:12px 14px; border-radius:10px; border:1px solid var(--line);
  background:var(--panel); color:var(--ink); box-shadow:var(--shadow); display:none; max-width: 520px;
}
.toast.err{ border-color:#40242a; background:#1a0f12; color:#ffb6b6 }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="section-title">Pernai</div>
    <div class="sidecard">
      <div class="kv"><span class="dot" id="dotClaude"></span> Claude</div>
      <div class="kv"><span class="dot" id="dotEmbed"></span> Embeddings</div>
      <div class="kv"><span style="font-size:12px;color:var(--muted)">Model:</span>
        <div id="model" class="kv" style="color:var(--ink)"></div></div>
      <div class="row" style="margin-top:10px">
        <button class="btn small secondary" id="btnHealth">Refresh</button>
        <button class="btn small ghost" id="btnData">Upload & Manage Data</button>
      </div>
    </div>

    <div class="section-title">Quick settings</div>
    <div class="sidecard">
      <div class="row" style="margin-bottom:8px">
        <label class="toggle"><input type="checkbox" id="useRag" checked>Use my data (RAG)</label>
      </div>
      <div class="row">
        <div style="flex:1">
          <label style="font-size:12px;color:var(--muted)">Top-K</label>
          <input id="topk" class="input" type="number" min="1" max="12" value="6">
        </div>
        <div style="flex:1">
          <label style="font-size:12px;color:var(--muted)">Max tokens</label>
          <input id="maxtok" class="input" type="number" min="100" max="4000" value="800">
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <section class="main">
    <div class="topbar">
      <span class="logo" title="Pernai">
        <!-- Inline 'P' emblem -->
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <path d="M0 0h100v100H0z" fill="url(#g)"/>
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#69a8ff"/><stop offset=".6" stop-color="#7ad6ff"/><stop offset="1" stop-color="#4dd6a9"/>
            </linearGradient>
          </defs>
        </svg>
      </span>
      <div class="brand">Pernai</div>
      <div class="badge" id="healthBadge">Checking‚Ä¶</div>
    </div>

    <div id="scroll" class="scroll">
      <!-- Messages will append here -->
    </div>

    <div class="composer">
      <div class="composer-inner">
        <div id="composerText" class="textarea" contenteditable="true" placeholder="Message Pernai‚Ä¶"></div>
        <div class="actions">
          <input type="file" id="imgFile" accept="image/*" style="display:none">
          <button class="btn secondary" id="btnImage">Attach Image</button>
          <button class="btn" id="btnSend">Send</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Upload / Manage Data Modal -->
<div id="mask" class="modal-mask"><div class="modal">
  <h3>Upload &amp; Manage Data</h3>
  <div class="row">
    <input type="file" id="files" multiple accept=".pdf,.txt,.md">
    <button class="btn" id="btnUpload">Upload</button>
    <button class="btn secondary" id="btnList">List Sources</button>
  </div>
  <hr>
  <div class="row">
    <input id="delName" class="input" placeholder="Exact filename to delete (see list)">
    <button class="btn ghost" id="btnDelete">Delete One</button>
  </div>
  <hr>
  <pre id="ingestOut" style="background:#0d1320;border:1px solid var(--line);padding:10px;border-radius:10px;max-height:220px;overflow:auto">‚Äì</pre>
  <div class="row" style="justify-content:flex-end;margin-top:10px">
    <button class="btn secondary" id="btnClose">Close</button>
  </div>
</div></div>

<div id="toast" class="toast"></div>

<script>
/* ------------- Utilities ------------- */
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
function toast(msg, isErr=false){
  const t = el('toast'); t.textContent = msg; t.classList.toggle('err', isErr);
  t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none', 4000);
}
async function getJSON(r){ const txt = await r.text(); try{ return {ok:r.ok, json:JSON.parse(txt), raw:txt} } catch{ return {ok:r.ok, json:null, raw:txt} } }
function addMsg(who, text, sources){
  const wrap = document.createElement('div'); wrap.className='message '+who;
  const a = document.createElement('div'); a.className='avatar'; a.textContent = who==='ai'?'P':'You';
  const b = document.createElement('div'); b.className='bubble'; b.textContent = text;
  wrap.appendChild(a); wrap.appendChild(b);
  if(who==='ai' && sources && sources.length){
    const s = document.createElement('div'); s.className='sources';
    s.textContent = 'Sources: ' + sources.map(x => (x.source || JSON.stringify(x))).join(' ‚Ä¢ ');
    b.appendChild(s);
  }
  el('scroll').appendChild(wrap);
  el('scroll').scrollTop = el('scroll').scrollHeight;
}
function typing(){
  const wrap = document.createElement('div'); wrap.className='message ai';
  wrap._isTyping = true;
  wrap.innerHTML = '<div class="avatar">P</div><div class="bubble muted">Thinking‚Ä¶</div>';
  el('scroll').appendChild(wrap);
  el('scroll').scrollTop = el('scroll').scrollHeight;
  return wrap;
}
function updateDots(okClaude, okEmbed){
  el('dotClaude').style.background = okClaude ? '#4dd6a9' : '#ff6a6a';
  el('dotEmbed').style.background = okEmbed ? '#4dd6a9' : '#ff6a6a';
}

/* ------------- Health ------------- */
async function refreshHealth(){
  el('healthBadge').textContent = 'Checking‚Ä¶';
  try{
    const r = await fetch('/health'); const {ok,json,raw}=await getJSON(r);
    if(!ok||!json){ el('healthBadge').textContent = 'Server error'; el('healthBadge').className='badge health-bad'; return; }
    updateDots(json.anthropic_ready, json.openai_ready);
    el('model').textContent = (json.model||'-') + ' ‚Ä¢ embed: ' + (json.embed_model||'-');
    el('healthBadge').textContent = (json.anthropic_ready && json.openai_ready) ? 'OK' : 'Check keys';
    el('healthBadge').className = 'badge ' + ((json.anthropic_ready && json.openai_ready)?'health-ok':'health-bad');
  }catch(e){
    el('healthBadge').textContent = 'Network error'; el('healthBadge').className='badge health-bad';
  }
}

/* ------------- Chat (text) ------------- */
async function sendChat(){
  const msg = el('composerText').innerText.trim();
  if(!msg) return;
  addMsg('user', msg);
  el('composerText').innerText='';
  const typingNode = typing();
  const payload = {
    message: msg,
    use_rag: el('useRag').checked,
    top_k: parseInt(el('topk').value||'6',10),
    max_tokens: parseInt(el('maxtok').value||'800',10)
  };
  try{
    const r = await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const {ok,json,raw}=await getJSON(r);
    el('scroll').removeChild(typingNode);
    if(!ok||!json){ addMsg('ai', `Server error (${r.status}): ${raw}`); return; }
    addMsg('ai', json.reply||'(no text)', json.sources||[]);
  }catch(e){
    el('scroll').removeChild(typingNode);
    addMsg('ai','Network error: '+e);
  }
}

/* ------------- Chat with image ------------- */
el('btnImage').addEventListener('click', ()=> el('imgFile').click());
el('imgFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  addMsg('user', 'üì∑ Sent an image.');
  const typingNode = typing();
  const fd = new FormData(); fd.append('file', file); fd.append('prompt','Extract text and answer.');
  try{
    const r = await fetch('/chat-image', {method:'POST', body: fd});
    const {ok,json,raw}=await getJSON(r); el('scroll').removeChild(typingNode);
    if(!ok||!json){ addMsg('ai', `Server error (${r.status}): ${raw}`); return; }
    addMsg('ai', json.reply||'(no text)');
  }catch(e){ el('scroll').removeChild(typingNode); addMsg('ai', 'Network error: '+e); }
});

/* ------------- Data modal ------------- */
function openModal(){ el('mask').style.display='flex'; }
function closeModal(){ el('mask').style.display='none'; }
el('btnData').onclick=openModal; el('btnClose').onclick=closeModal;

el('btnUpload').onclick = async ()=>{
  const input = el('files'); if(!input.files.length) return toast('Pick files first', true);
  const fd = new FormData(); for(const f of input.files) fd.append('files', f);
  el('ingestOut').textContent='Uploading‚Ä¶';
  try{
    const r = await fetch('/ingest', {method:'POST', body:fd});
    const {ok,json,raw}=await getJSON(r);
    if(!ok||!json){ el('ingestOut').textContent=`Server error (${r.status}): ${raw}`; toast('Upload failed', true); return; }
    el('ingestOut').textContent = JSON.stringify(json,null,2);
    toast('Upload complete');
  }catch(e){ el('ingestOut').textContent='Network error: '+e; toast('Upload failed', true); }
};
el('btnList').onclick = async ()=>{
  el('ingestOut').textContent='Loading‚Ä¶';
  try{
    const r = await fetch('/list'); const {ok,json,raw}=await getJSON(r);
    el('ingestOut').textContent = ok && json ? JSON.stringify(json,null,2) : `Server error (${r.status}): ${raw}`;
  }catch(e){ el('ingestOut').textContent='Network error: '+e; }
};
el('btnDelete').onclick = async ()=>{
  const name = el('delName').value.trim(); if(!name) return toast('Type a filename exactly as in list', true);
  try{
    const r = await fetch('/delete?source='+encodeURIComponent(name),{method:'POST'});
    const {ok,json,raw}=await getJSON(r);
    if(!ok||!json){ toast(`Delete failed (${r.status})`, true); return; }
    el('ingestOut').textContent = JSON.stringify(json,null,2);
    toast('Deleted (if it existed)');
  }catch(e){ toast('Network error: '+e, true); }
};

/* ------------- Bindings ------------- */
el('btnSend').onclick = sendChat;
el('btnHealth').onclick = refreshHealth;
el('composerText').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
});

/* ------------- Start ------------- */
refreshHealth();
addMsg('ai', 'Hi! I‚Äôm Pernai. Ask me anything ‚Äî toggle ‚ÄúUse my data (RAG)‚Äù in the left panel to query your uploaded PDFs/TXT/MD.');
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PranayAI</title>
  <style>
    :root {
      --bg: #0b0c10; --card:#11131a; --ink:#e9ecf1; --muted:#aab3c0; --acc:#6aa2ff; --acc2:#4dd6a9; --danger:#ff6a6a;
      --br: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #1a2333, transparent 50%), var(--bg);
      color: var(--ink);
    }
    header{
      padding: 28px 20px; text-align:center;
      border-bottom: 1px solid #1f2533;
      background: linear-gradient(180deg, rgba(106,162,255,.08), transparent);
    }
    header h1{ margin:0 0 6px; font-size: 28px; letter-spacing:.3px }
    header p{ margin:0; color:var(--muted) }

    .wrap{ max-width: 980px; margin: 24px auto 80px; padding: 0 16px }

    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: var(--card); border:1px solid #202534; border-radius: var(--br);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: 16px;
    }
    .span-12{ grid-column: span 12 }
    .span-8{ grid-column: span 8 }
    .span-4{ grid-column: span 4 }
    @media (max-width: 900px){ .span-8,.span-4{ grid-column: span 12 } }

    h2{ font-size: 18px; margin: 4px 0 12px; letter-spacing:.2px }
    label{ font-size: 14px; color: var(--muted); display:block; margin: 10px 0 6px }
    input[type="text"], textarea{
      width:100%; background:#0e1117; color:var(--ink);
      border:1px solid #262b3a; border-radius:10px; padding:12px 12px; outline:none;
    }
    textarea{ min-height: 110px; resize: vertical }
    input[type="file"]{ color:var(--muted) }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{
      background:var(--acc); color:#061020; border:none; border-radius:10px; padding:10px 14px;
      font-weight:600; cursor:pointer;
    }
    .btn.secondary{ background:#1b2434; color:var(--ink); border:1px solid #2b3347 }
    .btn.success{ background: var(--acc2); color:#041313 }
    .btn.danger{ background: var(--danger); color:#2b0a0a }
    .pill{ font-size:12px; padding:6px 8px; border-radius:36px; border:1px solid #2b3347; color:var(--muted) }

    pre{
      background:#0e1117; border:1px solid #262b3a; border-radius:10px; padding:12px; overflow:auto;
      white-space:pre-wrap; word-wrap:break-word; max-height: 340px;
    }
    .muted{ color:var(--muted) }
    .ok{ color: var(--acc2) }
    .err{ color: var(--danger) }
    .src{ font-size:12px; border:1px solid #2b3347; background:#0d121a; border-radius:8px; padding:8px; }

    footer{ text-align:center; color:var(--muted); font-size:12px; padding:24px 0 60px }
    a { color: var(--acc) }
    .spacer{ height:8px }
  </style>
</head>
<body>
  <header>
    <h1>PranayAI</h1>
    <p>Chat with your notes ‚Ä¢ Upload PDFs/TXT/MD ‚Ä¢ Ask with RAG</p>
  </header>

  <main class="wrap">

    <!-- Health / status -->
    <section class="grid">
      <div class="card span-12" id="statusCard">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2>Service status</h2>
          <button class="btn secondary" id="btnHealth">Refresh</button>
        </div>
        <div id="health" class="muted">Checking...</div>
      </div>
    </section>

    <!-- Chat -->
    <section class="grid">
      <div class="card span-8">
        <h2>Chat</h2>
        <label for="msg">Message</label>
        <textarea id="msg" placeholder="Ask me something (e.g., ‚Äòsummarize AP Biology Unit 3 using my notes‚Äô)"></textarea>

        <div class="row" style="margin:10px 0 12px">
          <label class="pill"><input type="checkbox" id="useRag" checked style="margin-right:6px">Use my uploaded data (RAG)</label>
          <span class="pill">Top K: <input id="topk" type="text" value="6" style="width:42px; margin-left:6px; background:transparent; border:none; color:var(--ink)"></span>
          <span class="pill">Max tokens: <input id="maxtok" type="text" value="800" style="width:56px; margin-left:6px; background:transparent; border:none; color:var(--ink)"></span>
          <button class="btn" id="btnSend">Send</button>
        </div>

        <div class="spacer"></div>
        <div class="muted">Reply</div>
        <pre id="reply">‚Äì</pre>

        <div class="spacer"></div>
        <div class="muted">Sources</div>
        <div id="sources" class="src">‚Äì</div>
      </div>

      <!-- Image chat -->
      <div class="card span-4">
        <h2>Chat with an Image</h2>
        <label for="imgPrompt">Prompt</label>
        <input id="imgPrompt" type="text" placeholder="e.g., Extract and answer from this photo" />

        <label for="imgFile">Image (JPG/PNG)</label>
        <input id="imgFile" type="file" accept="image/*" />

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnImg">Ask</button>
        </div>

        <div class="spacer"></div>
        <div class="muted">Image Reply</div>
        <pre id="imgReply">‚Äì</pre>
      </div>
    </section>

    <!-- Ingest -->
    <section class="grid">
      <div class="card span-12">
        <h2>Upload PDFs / TXT / MD</h2>
        <form id="ingestForm" class="row">
          <input id="files" type="file" multiple accept=".pdf,.txt,.md" />
          <button class="btn success" type="submit">Upload</button>
          <button class="btn secondary" type="button" id="btnList">List Sources</button>
          <button class="btn danger" type="button" id="btnClearOne">Delete One</button>
        </form>

        <div class="spacer"></div>
        <div class="muted">Ingest status</div>
        <pre id="ingestOut">‚Äì</pre>

        <div class="spacer"></div>
        <div class="muted">Current sources</div>
        <pre id="listOut">‚Äì</pre>
      </div>
    </section>
  </main>

  <footer>
    <span>&copy; <script>document.write(new Date().getFullYear())</script> PranayAI</span>
  </footer>

  <script>
    // Helpers
    function show(el, text, isError=false){
      const node = (typeof el === 'string') ? document.getElementById(el) : el;
      node.textContent = text;
      node.classList.toggle('err', !!isError);
      node.classList.toggle('ok', !isError);
    }
    async function getJSON(res){
      const t = await res.text();
      try { return { ok: res.ok, json: JSON.parse(t), raw: t } }
      catch { return { ok: res.ok, json: null, raw: t } }
    }

    // Health
    async function refreshHealth(){
      show('health', 'Checking‚Ä¶');
      try{
        const res = await fetch('/health');
        const { ok, json, raw } = await getJSON(res);
        if(!ok) return show('health', `Server error (${res.status}): ${raw}`, true);
        const bits = [
          json.ok ? 'OK' : 'NOT OK',
          `Claude: ${json.anthropic_ready ? 'ready' : 'not ready'}`,
          `Embeddings: ${json.openai_ready ? 'ready' : 'not ready'}`,
          `Model: ${json.model || '-'}`,
          `Embed: ${json.embed_model || '-'}`
        ];
        show('health', bits.join(' ‚Ä¢ '));
      }catch(e){ show('health', 'Network error: '+e, true); }
    }

    // Chat
    async function sendChat(){
      const message = document.getElementById('msg').value.trim();
      const useRag  = document.getElementById('useRag').checked;
      const topK    = parseInt(document.getElementById('topk').value || '6', 10);
      const maxTok  = parseInt(document.getElementById('maxtok').value || '800', 10);
      if(!message){ return; }

      show('reply', 'Thinking‚Ä¶'); show('sources','‚Äì');
      try{
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, use_rag: useRag, top_k: topK, max_tokens: maxTok })
        });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json){
          return show('reply', `Server error (${res.status}): ${raw}`, true);
        }
        show('reply', json.reply || '(no text)');
        const srcs = (json.sources && json.sources.length)
          ? json.sources.map(s => JSON.stringify(s)).join('\n')
          : '‚Äì';
        show('sources', srcs, false);
      }catch(e){
        show('reply', 'Network error: '+e, true);
      }
    }

    // Image Chat
    async function sendImage(){
      const prompt = document.getElementById('imgPrompt').value.trim() || 'Extract text and answer.';
      const file = document.getElementById('imgFile').files[0];
      if(!file){ return show('imgReply','Pick an image first.', true); }

      const fd = new FormData();
      fd.append('file', file);
      fd.append('prompt', prompt);

      show('imgReply', 'Thinking‚Ä¶');
      try{
        const res = await fetch('/chat-image', { method: 'POST', body: fd });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json){
          return show('imgReply', `Server error (${res.status}): ${raw}`, true);
        }
        show('imgReply', json.reply || '(no text)');
      }catch(e){
        show('imgReply', 'Network error: '+e, true);
      }
    }

    // Ingest
    async function ingestFiles(e){
      e.preventDefault();
      const fInput = document.getElementById('files');
      if(!fInput.files.length){ return; }

      const fd = new FormData();
      for(const f of fInput.files) fd.append('files', f);

      show('ingestOut','Uploading‚Ä¶');
      try{
        const res = await fetch('/ingest', { method:'POST', body: fd });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return show('ingestOut', `Server error (${res.status}): ${raw}`, true);
        show('ingestOut', JSON.stringify(json, null, 2));
      }catch(e){
        show('ingestOut', 'Network error: '+e, true);
      }
    }

    // List
    async function listSources(){
      show('listOut','Loading‚Ä¶');
      try{
        const res = await fetch('/list');
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return show('listOut', `Server error (${res.status}): ${raw}`, true);
        show('listOut', JSON.stringify(json, null, 2));
      }catch(e){
        show('listOut', 'Network error: '+e, true);
      }
    }

    // Delete one (by exact filename)
    async function deleteOne(){
      const name = prompt('Type the exact filename to delete (as shown in /list):');
      if(!name) return;
      try{
        const url = `/delete?source=${encodeURIComponent(name)}`;
        const res = await fetch(url, { method:'POST' });
        const { ok, json, raw } = await getJSON(res);
        if(!ok || !json) return alert(`Server error (${res.status}): ${raw}`);
        alert(JSON.stringify(json, null, 2));
      }catch(e){
        alert('Network error: '+e);
      }
    }

    // Wire up UI
    document.getElementById('btnHealth').onclick = refreshHealth;
    document.getElementById('btnSend').onclick = sendChat;
    document.getElementById('btnImg').onclick = sendImage;
    document.getElementById('ingestForm').onsubmit = ingestFiles;
    document.getElementById('btnList').onclick = listSources;
    document.getElementById('btnClearOne').onclick = deleteOne;

    // Initial check
    refreshHealth();
  </script>
</body>
</html>
